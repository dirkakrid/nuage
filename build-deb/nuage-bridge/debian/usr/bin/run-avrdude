#!/bin/sh

# FIXME! Use avrdude to find out which MCU we are using and which baudrate is used for uploading!

port=18

# Modify inittab
sed -i 's/^T0\:23/#-NUAGE-T0:23/g' /etc/inittab
init Q

# Reset

# test -d /sys/class/gpio/gpio${port} || echo "$port" > /sys/class/gpio/export
#echo "out" >  /sys/class/gpio/gpio${port}/direction
#echo "0"   >  /sys/class/gpio/gpio${port}/value
#/bin/sleep 0.25
#echo "1"   >  /sys/class/gpio/gpio${port}/value
#/bin/sleep 0.50
#echo "0"   >  /sys/class/gpio/gpio${port}/value

# /usr/bin/avrdude-autoreset -patmega328p -carduino -P /dev/ttyAMA0 -v -U lfuse:r:-:i -b57600

/usr/bin/avrdude-autoreset -C/etc/avrdude.conf -v \
        -patmega328p -carduino \
        -P/dev/ttyAMA0 -b57600 \
        -D -Uflash:w:/tmp/sketch.hex:i || \
/usr/bin/avrdude-autoreset -C/etc/avrdude.conf -v \
        -patmega328p -carduino \
        -P/dev/ttyAMA0 -b115200 \
        -D -Uflash:w:/tmp/sketch.hex:i

# Restore inittab
sed -i 's/^\#-NUAGE-T0\:23/T0:23/g' /etc/inittab
init Q
exit 0

